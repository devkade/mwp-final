# 사용자 플로우 (User Flow)

## 1. Android 앱 사용자 플로우

### 1.1 전체 네비게이션 구조

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           GymApp Navigation Flow                             │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │  SplashActivity │
                              │  (앱 시작)       │
                              └────────┬────────┘
                                       │
                          ┌────────────┴────────────┐
                          │                         │
                    세션 없음                    세션 있음
                          │                         │
                          ▼                         ▼
                 ┌─────────────────┐      ┌─────────────────┐
                 │  LoginActivity  │      │ MachineListAct  │
                 │  (로그인 화면)   │      │  (기구 목록)     │
                 └────────┬────────┘      └────────┬────────┘
                          │                        │
                   로그인 성공                      │
                          │                        │
                          └────────────┬───────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │ MachineListAct  │
                              │  (기구 목록)     │◀──────────────────┐
                              └────────┬────────┘                   │
                                       │                            │
                                  기구 클릭                      로그아웃
                                       │                            │
                                       ▼                            │
                          ┌────────────────────────┐                │
                          │    AlertDialog         │                │
                          │  ┌──────────────────┐  │                │
                          │  │ 이벤트 목록       │  │                │
                          │  │ 사용 통계        │  │                │
                          │  └──────────────────┘  │                │
                          └───────────┬────────────┘                │
                                      │                             │
                     ┌────────────────┴────────────────┐            │
                     │                                 │            │
              이벤트 목록 선택                    통계 선택           │
                     │                                 │            │
                     ▼                                 ▼            │
            ┌─────────────────┐              ┌─────────────────┐    │
            │ EventListAct    │              │  StatsActivity  │    │
            │ (이벤트 목록)    │              │  (통계 화면)     │    │
            └────────┬────────┘              └─────────────────┘    │
                     │                                              │
                이벤트 클릭                                          │
                     │                                              │
                     ▼                                              │
            ┌─────────────────┐                                     │
            │ EventDetailAct  │                                     │
            │ (이벤트 상세)    │                                     │
            └─────────────────┘                                     │
                                                                    │
            ┌─────────────────┐                                     │
            │ ImageViewerDlg  │  (이미지 썸네일 클릭 시)             │
            │ (이미지 확대)    │                                     │
            └─────────────────┘                                     │
```

---

### 1.2 화면별 상세 플로우

#### 1.2.1 로그인 화면 (LoginActivity)

```
┌────────────────────────────────────────┐
│            GymFlow                     │
│                                        │
│    ┌────────────────────────────────┐  │
│    │  Security Key 입력              │  │
│    │  ********************************│  │
│    └────────────────────────────────┘  │
│                                        │
│    ┌────────────────────────────────┐  │
│    │          로그인                  │  │
│    └────────────────────────────────┘  │
│                                        │
└────────────────────────────────────────┘
```

**동작:**
1. Security Key 입력
2. "로그인" 버튼 클릭
3. 서버 인증 (POST /api/auth/login/)
4. 성공 → MachineListActivity로 이동
5. 실패 → 에러 메시지 표시

**에러 처리:**
- 잘못된 키: "잘못된 보안키입니다"
- 네트워크 오류: "네트워크 오류가 발생했습니다"

---

#### 1.2.2 기구 목록 화면 (MachineListActivity)

```
┌────────────────────────────────────────┐
│  GymFlow                         [≡]  │
├────────────────────────────────────────┤
│                                        │
│  ┌──────┐  런닝머신 01                 │
│  │ 🏃‍♂️ │  1층 A구역                   │
│  │      │  이벤트 42건                 │
│  └──────┘                      [>]    │
│  ─────────────────────────────────     │
│  ┌──────┐  벤치프레스 02               │
│  │ 🏋️ │  1층 B구역                   │
│  │      │  이벤트 28건                 │
│  └──────┘                      [>]    │
│  ─────────────────────────────────     │
│  ┌──────┐  스쿼트랙 01                 │
│  │ 🦵 │  2층 A구역                   │
│  │      │  이벤트 35건                 │
│  └──────┘                      [>]    │
│                                        │
│          ↓ 당겨서 새로고침             │
└────────────────────────────────────────┘
```

**동작:**
1. 활성 기구 목록 로드 (GET /api_root/machines/)
2. Pull-to-Refresh로 새로고침
3. 기구 클릭 → 선택 다이얼로그
4. 메뉴 → 로그아웃

---

#### 1.2.3 이벤트 목록 화면 (EventListActivity)

```
┌────────────────────────────────────────┐
│  [←]  런닝머신 01 이벤트               │
├────────────────────────────────────────┤
│  ┌──────┬──────┬──────┐               │
│  │ 전체 │ 시작 │ 종료 │  (필터)       │
│  └──────┴──────┴──────┘               │
│  📅 2025-12-01 ~ 2025-12-19           │
├────────────────────────────────────────┤
│                                        │
│  ┌──────┐  사용 시작                   │
│  │ 📷  │  2025-12-19 19:30            │
│  │      │  감지 인원: 1명              │
│  └──────┘                              │
│  ─────────────────────────────────     │
│  ┌──────┐  사용 종료                   │
│  │ 📷  │  2025-12-19 19:45            │
│  │      │  감지 인원: 0명              │
│  └──────┘                              │
│  ─────────────────────────────────     │
│                                        │
└────────────────────────────────────────┘
```

**동작:**
1. 기구별 이벤트 목록 로드
2. ChipGroup으로 이벤트 타입 필터링
3. 날짜 범위 선택
4. 이벤트 클릭 → 상세 화면
5. 썸네일 클릭 → 이미지 확대

---

#### 1.2.4 통계 화면 (StatsActivity)

```
┌────────────────────────────────────────┐
│  [←]  런닝머신 01 통계                 │
├────────────────────────────────────────┤
│  📅 최근 7일                    [▼]   │
├────────────────────────────────────────┤
│                                        │
│  ┌────────────────────────────────┐   │
│  │ 총 사용 횟수        42회       │   │
│  └────────────────────────────────┘   │
│  ┌────────────────────────────────┐   │
│  │ 가장 바쁜 날    12/19 (8회)    │   │
│  └────────────────────────────────┘   │
│                                        │
│  일별 사용량                           │
│  ┌────────────────────────────────┐   │
│  │     ▓▓                         │   │
│  │  ▓▓ ▓▓    ▓▓ ▓▓              │   │
│  │  ▓▓ ▓▓ ▓▓ ▓▓ ▓▓ ▓▓ ▓▓       │   │
│  │  ─────────────────────────     │   │
│  │  13 14 15 16 17 18 19          │   │
│  └────────────────────────────────┘   │
│                                        │
└────────────────────────────────────────┘
```

**동작:**
1. 기구별 통계 로드 (GET /api_root/machines/{id}/stats/)
2. MaterialDatePicker로 기간 변경
3. 막대 차트로 일별 사용량 표시
4. 메트릭 카드로 요약 정보

---

#### 1.2.5 이미지 확대 (ImageViewerDialog)

```
┌────────────────────────────────────────┐
│                                   [X] │
│                                        │
│                                        │
│                                        │
│           ┌──────────────┐             │
│           │              │             │
│           │   감지된     │             │
│           │   이미지     │             │
│           │              │             │
│           └──────────────┘             │
│                                        │
│                                        │
├────────────────────────────────────────┤
│  사용 시작                             │
│  2025-12-19 19:30                      │
│  감지 인원: 1명                        │
└────────────────────────────────────────┘
```

**동작:**
1. 전체화면 이미지 표시
2. 하단 오버레이에 이벤트 정보
3. X 버튼 또는 배경 터치로 닫기

---

## 2. 웹 대시보드 사용자 플로우

### 2.1 관리자 플로우

```
┌─────────────┐
│   로그인     │  Security Key 입력
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  대시보드    │  전체 기구 현황
└──────┬──────┘
       │
       ├─────────────┬─────────────┬─────────────┐
       │             │             │             │
       ▼             ▼             ▼             ▼
┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐
│ 기구 상세  │ │ 사용 이력  │ │ 사용자 관리│ │ 기구 추가  │
└───────────┘ └───────────┘ └───────────┘ └───────────┘
```

### 2.2 웹 페이지 구성

| URL | 기능 |
|-----|------|
| `/` | 로그인 페이지 |
| `/dashboard/` | 대시보드 (기구 목록) |
| `/equipment/<id>/` | 기구 상세 정보 |
| `/equipment/<id>/history/` | 기구별 사용 이력 |
| `/users/` | API 사용자 목록 |
| `/users/add/` | 사용자 추가 |
| `/machines/add/` | 기구 추가 |

---

## 3. Edge 시스템 운영 플로우

### 3.1 초기 설정

```
1. 환경 설정
   ├── 환경변수 설정 (GYM_HOST, GYM_SECURITY_KEY, GYM_MACHINE_ID)
   └── 또는 YAML 설정 파일 작성

2. 카메라/소스 준비
   ├── 웹캠 연결 확인
   ├── RTSP 스트림 URL 확인
   └── 동영상 파일 준비

3. 실행
   └── python detect.py --weights yolov5s.pt --source <소스>
```

### 3.2 운영 모니터링

```
┌───────────────────────────────────────────────────────────────┐
│                    Edge 시스템 로그 해석                       │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  [ChangeDetection] State change detected, waiting 5.0s: start │
│  → 사람 감지됨, 5초 대기 시작                                  │
│                                                               │
│  [ChangeDetection] Pending start: 3.2s remaining              │
│  → 대기 중, 남은 시간 표시                                     │
│                                                               │
│  [ChangeDetection] Pending start cancelled - state reverted   │
│  → 5초 이내 감지 해제, 이벤트 취소                             │
│                                                               │
│  [ChangeDetection] Event triggered after 5.0s: start          │
│  → 5초 연속 감지 확인, START 이벤트 발생                       │
│                                                               │
│  [ChangeDetection] Event sent: start                          │
│  → 서버 전송 성공                                              │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

---

## 4. 데이터 플로우

### 4.1 이벤트 생성 ~ 조회 전체 흐름

```
[카메라]
    │
    ▼
[YOLOv5 감지]
    │
    ▼
[ChangeDetection] ── 5초 디바운싱 ──▶ [이벤트 발생]
    │                                      │
    │                                      ▼
    │                              [이미지 캡처]
    │                                      │
    │                                      ▼
    │                              [API 전송]
    │                                      │
    │                                      ▼
    │                              ┌──────────────┐
    │                              │ Django Server │
    │                              │              │
    │                              │ MachineEvent │
    │                              │ 생성 및 저장 │
    │                              └──────────────┘
    │                                      │
    │         ┌────────────────────────────┤
    │         │                            │
    │         ▼                            ▼
    │  ┌──────────────┐           ┌──────────────┐
    │  │ 웹 대시보드   │           │ Android App  │
    │  │              │           │              │
    │  │ 이벤트 조회  │           │ 이벤트 조회  │
    │  │ 통계 확인   │           │ 이미지 확대  │
    │  └──────────────┘           │ 통계 차트   │
    │                             └──────────────┘
    │
    └── [다음 프레임 처리]
```

---

## 5. 에러 처리 플로우

### 5.1 네트워크 오류

```
[API 요청]
    │
    ├── 성공 → 정상 처리
    │
    └── 실패
         │
         ├── 401 Unauthorized
         │   └── 로그아웃 → 로그인 화면
         │
         ├── 404 Not Found
         │   └── "데이터를 찾을 수 없습니다" 표시
         │
         ├── 500+ Server Error
         │   └── "서버 오류가 발생했습니다" 표시
         │
         └── Network Error
             └── "네트워크 오류가 발생했습니다" 표시
```

### 5.2 빈 데이터 처리

```
[데이터 로드]
    │
    ├── 데이터 있음 → RecyclerView 표시
    │
    └── 데이터 없음
         │
         └── Empty State 표시
             ├── "등록된 기구가 없습니다" (기구 목록)
             ├── "이벤트가 없습니다" (이벤트 목록)
             └── "통계 데이터가 없습니다" (통계)
```

---

*문서 버전: 1.0 | 작성일: 2025-12-20*
