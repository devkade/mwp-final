# 시스템 플로우 (System Flow)

## 개요

GymFlow는 3-Tier 아키텍처로 구성된 헬스장 장비 모니터링 시스템입니다.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           GymFlow System Architecture                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐     HTTP/REST      ┌─────────────────┐     HTTP/REST      ┌─────────────────┐
│   YOLOv5 Edge   │ ─────────────────▶ │   GymServer     │ ◀───────────────── │    GymApp       │
│   (Camera/AI)   │                    │   (Django API)  │                    │   (Android)     │
│                 │                    │                 │                    │                 │
│  • 실시간 감지   │                    │  • 데이터 저장   │                    │  • UI 표시      │
│  • 이벤트 전송   │                    │  • API 제공     │                    │  • 이벤트 조회  │
│  • 이미지 캡처   │                    │  • 통계 계산    │                    │  • 통계 시각화  │
└─────────────────┘                    └─────────────────┘                    └─────────────────┘
```

---

## 1. 데이터 흐름 (Data Flow)

### 1.1 감지 → 서버 저장 흐름

```
[카메라/영상 소스]
        │
        ▼
┌───────────────────┐
│   YOLOv5 detect   │  프레임 분석
└───────────────────┘
        │
        ▼
┌───────────────────┐
│  ChangeDetection  │  상태 변화 감지 (idle ↔ active)
│                   │  5초 디바운싱
└───────────────────┘
        │
        │  상태 변화 확정 시
        ▼
┌───────────────────┐
│   이미지 캡처     │  현재 프레임 저장 (640x480)
└───────────────────┘
        │
        ▼
┌───────────────────┐
│   API 전송        │  POST /api/machines/{id}/events/
│   (multipart)     │  • event_type (start/end)
│                   │  • image (캡처 이미지)
│                   │  • detections (YOLO 결과)
│                   │  • change_info (상태 정보)
└───────────────────┘
        │
        ▼
┌───────────────────┐
│   Django Server   │  MachineEvent 생성 및 저장
└───────────────────┘
```

### 1.2 앱 → 서버 조회 흐름

```
┌───────────────────┐
│   Android App     │
└───────────────────┘
        │
        │  GET /api_root/machines/
        ▼
┌───────────────────┐
│   기구 목록       │  활성 기구 목록 조회
└───────────────────┘
        │
        │  GET /api/machines/{id}/events/
        ▼
┌───────────────────┐
│   이벤트 목록     │  필터링: 날짜, 이벤트 타입
└───────────────────┘
        │
        │  GET /api_root/machines/{id}/stats/
        ▼
┌───────────────────┐
│   통계 데이터     │  일별 사용량 집계
└───────────────────┘
```

---

## 2. 인증 흐름 (Authentication Flow)

### 2.1 보안키 기반 인증

```
┌─────────────┐                              ┌─────────────┐
│  클라이언트  │                              │   서버      │
└─────────────┘                              └─────────────┘
       │                                            │
       │  POST /api/auth/login/                     │
       │  {"security_key": "abc123..."}             │
       │ ─────────────────────────────────────────▶ │
       │                                            │
       │                                     ┌──────┴──────┐
       │                                     │ ApiUser     │
       │                                     │ 조회        │
       │                                     └──────┬──────┘
       │                                            │
       │                                     ┌──────┴──────┐
       │                                     │ Token       │
       │                                     │ 생성/반환    │
       │                                     └──────┬──────┘
       │                                            │
       │  {"token": "xxx", "name": "사용자"}        │
       │ ◀───────────────────────────────────────── │
       │                                            │
       │  Authorization: Token xxx                  │
       │  (이후 모든 API 호출)                       │
       │ ─────────────────────────────────────────▶ │
       │                                            │
```

### 2.2 인증 주체

| 주체 | 인증 방식 | 용도 |
|------|----------|------|
| YOLOv5 Edge | Security Key → Token | 이벤트 전송 |
| Android App | Security Key → Token | 데이터 조회 |
| Web Dashboard | Security Key → Session | 관리 기능 |

---

## 3. 상태 감지 흐름 (State Detection Flow)

### 3.1 디바운싱 상태 머신

```
                                    ┌─────────────────────────────┐
                                    │      IDLE (미감지 상태)      │
                                    │      confirmed_state=idle    │
                                    └──────────────┬──────────────┘
                                                   │
                                          사람 감지됨 (count >= 1)
                                                   │
                                                   ▼
                          ┌─────────────────────────────────────────────────┐
                          │           PENDING_START (대기 상태)              │
                          │           pending_state=start                   │
                          │           타이머 시작: 5초                        │
                          └────────────────────┬────────────────────────────┘
                                               │
                     ┌─────────────────────────┼─────────────────────────┐
                     │                         │                         │
           5초 이내 미감지됨              5초 동안 계속 감지             (취소)
                     │                         │                         │
                     ▼                         ▼                         │
        ┌────────────────────┐    ┌────────────────────────┐            │
        │ IDLE로 복귀        │    │ START 이벤트 발생      │            │
        │ pending 취소       │    │ → 서버로 전송          │            │
        └────────────────────┘    │ confirmed_state=active │            │
                                  └───────────┬────────────┘            │
                                              │                         │
                                              ▼                         │
                          ┌─────────────────────────────────────────────┘
                          │
                          ▼
                    ┌─────────────────────────────┐
                    │     ACTIVE (감지 상태)       │
                    │     confirmed_state=active   │
                    └──────────────┬──────────────┘
                                   │
                          사람 미감지됨 (count = 0)
                                   │
                                   ▼
                          ┌─────────────────────────────────────────────────┐
                          │           PENDING_END (대기 상태)                │
                          │           pending_state=end                     │
                          │           타이머 시작: 5초                        │
                          └────────────────────┬────────────────────────────┘
                                               │
                     ┌─────────────────────────┼─────────────────────────┐
                     │                         │                         │
           5초 이내 다시 감지            5초 동안 계속 미감지           (취소)
                     │                         │                         │
                     ▼                         ▼                         │
        ┌────────────────────┐    ┌────────────────────────┐            │
        │ ACTIVE로 복귀      │    │ END 이벤트 발생        │            │
        │ pending 취소       │    │ → 서버로 전송          │ ───────────┘
        └────────────────────┘    │ confirmed_state=idle   │
                                  └────────────────────────┘
```

### 3.2 디바운싱 효과

| 시나리오 | 기존 문제 | 디바운싱 적용 후 |
|---------|----------|-----------------|
| 잠깐 지나감 | 불필요한 START/END 발생 | 5초 미만이면 무시 |
| 카메라 흔들림 | 순간적 미감지로 END 발생 | 5초간 안정 확인 후 이벤트 |
| 복수 인원 교체 | 각각 START/END 발생 | 연속적으로 인원 있으면 유지 |

---

## 4. API 통신 흐름

### 4.1 이벤트 생성 (Edge → Server)

```http
POST /api/machines/1/events/
Authorization: Token abc123...
Content-Type: multipart/form-data

event_type=start
captured_at=2025-12-19T19:30:00
person_count=1
image=@capture.jpg
detections=[{"class":"person","confidence":0.85,"bbox":[100,200,300,400]}]
change_info={"event_type":"start","prev_count":0,"curr_count":1}
```

### 4.2 이벤트 조회 (App → Server)

```http
GET /api/machines/1/events/?event_type=start&date_from=2025-12-01&date_to=2025-12-19
Authorization: Token abc123...

Response:
{
  "count": 42,
  "next": "/api/machines/1/events/?page=2",
  "results": [
    {
      "id": 100,
      "event_type": "start",
      "event_type_display": "사용 시작",
      "image": "/media/events/2025/12/19/capture.jpg",
      "captured_at": "2025-12-19T19:30:00",
      "person_count": 1
    }
  ]
}
```

---

## 5. 컴포넌트 간 의존성

```
┌─────────────────────────────────────────────────────────────────┐
│                        GymFlow Dependencies                      │
└─────────────────────────────────────────────────────────────────┘

YOLOv5 Edge                    Django Server                 Android App
─────────────                  ─────────────                 ───────────
  PyTorch                        Django 5.2                   Java 17
  OpenCV                         DRF 3.15                     Android SDK 36
  Requests                       SQLite3                      HttpURLConnection
  PyYAML                         Pillow                       MPAndroidChart
     │                              │                              │
     └──────────────────────────────┼──────────────────────────────┘
                                    │
                              REST API
                         (JSON + multipart)
```

---

*문서 버전: 1.0 | 작성일: 2025-12-20*
